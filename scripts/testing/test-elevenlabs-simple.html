<!DOCTYPE html>
<html>
<head>
    <title>ElevenLabs TTS Test</title>
</head>
<body>
    <h1>ElevenLabs TTS Test</h1>
    <div>
        <label>API Key: <input type="password" id="apiKey" placeholder="Enter ElevenLabs API Key"></label><br><br>
        <label>Voice ID: <input type="text" id="voiceId" placeholder="Enter Voice ID" value="QgANejRxHKptfmIRwYjz"></label><br><br>
        <label>Text: <textarea id="text" rows="3" cols="50">Hello, this is a test of ElevenLabs text-to-speech.</textarea></label><br><br>
        <button onclick="testTTS()">Test TTS</button>
        <button onclick="testAPI()">Test API</button>
    </div>
    <div id="output"></div>
    <audio id="audio" controls style="display:none;"></audio>

    <script>
        function log(message) {
            document.getElementById('output').innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
        }

        async function testAPI() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                log('‚ùå Please enter API key');
                return;
            }

            log('Testing ElevenLabs API...');
            try {
                const response = await fetch('https://api.elevenlabs.io/v1/voices', {
                    headers: {
                        'xi-api-key': apiKey,
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ API working! Found ' + data.voices.length + ' voices');
                    if (data.voices.length > 0) {
                        log('Sample voices: ' + data.voices.slice(0, 3).map(v => v.name).join(', '));
                    }
                } else {
                    const errorText = await response.text();
                    log('‚ùå API Error: ' + response.status + ' - ' + errorText);
                }
            } catch (error) {
                log('‚ùå API Test Failed: ' + error.message);
            }
        }

        async function testTTS() {
            const apiKey = document.getElementById('apiKey').value;
            const voiceId = document.getElementById('voiceId').value;
            const text = document.getElementById('text').value;

            if (!apiKey || !voiceId || !text) {
                log('‚ùå Please fill in all fields');
                return;
            }

            log('Generating speech...');
            try {
                const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': apiKey,
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: 'eleven_multilingual_v2',
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.75,
                        },
                        output_format: 'mp3_44100_128'
                    }),
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    log('‚úÖ Speech generated! Size: ' + audioBlob.size + ' bytes');
                    
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = document.getElementById('audio');
                    audio.src = audioUrl;
                    audio.style.display = 'block';
                    
                    try {
                        await audio.play();
                        log('‚úÖ Audio playing successfully!');
                    } catch (playError) {
                        log('‚ùå Playback failed: ' + playError.message);
                        log('üí° Try clicking the play button manually');
                    }
                } else {
                    const errorText = await response.text();
                    log('‚ùå TTS Error: ' + response.status + ' - ' + errorText);
                }
            } catch (error) {
                log('‚ùå TTS Test Failed: ' + error.message);
            }
        }

        // Auto-fill API key if available
        window.onload = function() {
            const savedKey = localStorage.getItem('cmf_elevenlabs_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                log('Auto-filled API key from localStorage');
            }
        };
    </script>
</body>
</html>
